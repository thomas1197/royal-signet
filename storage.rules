rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function: Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function: Check if user owns the resource
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper function: Check if user has admin or pastor role
    function isAdmin() {
      return isSignedIn() &&
        request.auth.token.role in ['admin', 'pastor'];
    }

    // Helper function: Validate image file
    function isValidImage() {
      return request.resource.contentType.matches('image/.*')
        && request.resource.size < 5 * 1024 * 1024; // Max 5MB
    }

    // Helper function: Validate audio file
    function isValidAudio() {
      return request.resource.contentType.matches('audio/.*')
        && request.resource.size < 100 * 1024 * 1024; // Max 100MB for sermons
    }

    // Helper function: Validate video file
    function isValidVideo() {
      return request.resource.contentType.matches('video/.*')
        && request.resource.size < 500 * 1024 * 1024; // Max 500MB
    }

    // Profile pictures - users can only manage their own
    match /profilePictures/{userId}/{fileName} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId) && isValidImage();
      allow delete: if isOwner(userId);
    }

    // Sermon media - public read, only admin/pastor can write
    match /sermons/{sermonId}/{fileName} {
      allow read: if true; // Public access for sermons
      allow write: if isAdmin() && (isValidAudio() || isValidVideo() || isValidImage());
      allow delete: if isAdmin();
    }

    // Event images - public read, only admin/pastor can write
    match /events/{eventId}/{fileName} {
      allow read: if true; // Public access for event images
      allow write: if isAdmin() && isValidImage();
      allow delete: if isAdmin();
    }

    // Church updates/announcements images - public read, admin write
    match /updates/{updateId}/{fileName} {
      allow read: if true;
      allow write: if isAdmin() && isValidImage();
      allow delete: if isAdmin();
    }

    // Prayer request attachments - owner and admin access only
    match /prayers/{prayerId}/{fileName} {
      allow read: if isSignedIn(); // Authenticated users can view
      allow write: if isSignedIn() && isValidImage();
      allow delete: if isAdmin();
    }

    // Life group materials - authenticated read, admin write
    match /lifeGroups/{groupId}/{fileName} {
      allow read: if isSignedIn();
      allow write: if isAdmin() && (isValidImage() || request.resource.contentType == 'application/pdf');
      allow delete: if isAdmin();
    }

    // Sunday school materials - authenticated read, admin write
    match /sundaySchool/{materialId}/{fileName} {
      allow read: if isSignedIn();
      allow write: if isAdmin() && (isValidImage() || request.resource.contentType == 'application/pdf');
      allow delete: if isAdmin();
    }

    // Church logo and branding assets - public read, admin write
    match /branding/{fileName} {
      allow read: if true;
      allow write: if isAdmin() && isValidImage();
      allow delete: if isAdmin();
    }

    // Deny all other paths by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
